# Generated by Django 4.2.14 on 2024-09-20 23:12

from django.db import migrations, models
import django.db.models.deletion
from django.utils import timezone
from datetime import timedelta


def create_reviewers(apps, schema):
    PeerReviewInvitation = apps.get_model("library", "PeerReviewInvitation")
    PeerReviewer = apps.get_model("library", "PeerReviewer")
    PeerReviewerFeedback = apps.get_model("library", "PeerReviewerFeedback")

    one_year_ago = timezone.now() - timedelta(days=365)
    for invitation in PeerReviewInvitation.objects.all():
        member_profile = invitation.candidate_reviewer
        reviewer, created = PeerReviewer.objects.get_or_create(
            member_profile=member_profile,
            defaults={
                "is_active": PeerReviewerFeedback.objects.filter(
                    invitation__candidate_reviewer=member_profile,
                    last_modified__gte=one_year_ago,
                ).exists()
            },
        )
        invitation.reviewer = reviewer
        invitation.save()


class Migration(migrations.Migration):

    dependencies = [
        ("library", "0029_peerreviewer"),
    ]

    operations = [
        migrations.AddField(
            model_name="peerreviewinvitation",
            name="reviewer",
            field=models.ForeignKey(
                null=True,
                on_delete=django.db.models.deletion.PROTECT,
                related_name="invitation_set",
                to="library.peerreviewer",
            ),
        ),
        migrations.RunPython(create_reviewers),
        migrations.AlterUniqueTogether(
            name="peerreviewinvitation",
            unique_together={("review", "reviewer")},
        ),
    ]
